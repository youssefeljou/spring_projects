<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Checkout</title>
    <script defer th:inline="javascript">
        /*<![CDATA[*/
        const cartId = [[${cartId}]];
        const customerId = [[${customerId}]];

        document.addEventListener('DOMContentLoaded', () => {
          const cardSection = document.getElementById('card-area');
          const newCardFields = document.getElementById('new-fields');
          const declineCheckbox = document.getElementById('decline-box');
          const payButton = document.getElementById('pay-btn');

          document.querySelectorAll('input[name="payMethod"]').forEach(el =>
            el.addEventListener('change', () => {
              const isCard = el.value === 'CARD';
              cardSection.classList.toggle('hidden', !isCard);
              declineCheckbox.classList.toggle('hidden', !isCard);
            })
          );

          document.querySelectorAll('input[name="cardOption"]').forEach(el =>
            el.addEventListener('change', () => {
              newCardFields.classList.toggle('hidden', el.value !== 'new');
            })
          );

          payButton.addEventListener('click', async () => {
            const method = document.querySelector('input[name="payMethod"]:checked')?.value;
            if (!method) return showModal('Validation Error', 'Please select a payment method');

            const payload = {
              cardId: null,
              number: null,
              cardHolderName: null,
              expMonth: null,
              expYear: null,
              cvc: null,
              simulateFailure: document.getElementById('decline')?.checked || false
            };

            if (method === 'CASH') {
              const res = await fetch(`/checkout/${cartId}?method=CASH`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
              });
              if (res.ok) return showModal('Success', 'Order placed successfully', () =>
                location.href = `/orders/customer/${customerId}`);
              return showModal('Payment Failed', await res.text());
            }

            const selectedCard = document.querySelector('input[name="cardOption"]:checked');
            if (!selectedCard) return showModal('Validation Error', 'Please select or enter a card');

            if (selectedCard.value === 'new') {
              payload.cardHolderName = document.getElementById('holder').value.trim();
              payload.number = document.getElementById('pan').value.replace(/\D/g, '');
              payload.expMonth = +document.getElementById('mm').value;
              payload.expYear = 2000 + +document.getElementById('yy').value;
              payload.cvc = document.getElementById('cvv').value.trim();
            } else {
              payload.cardId = +selectedCard.value;
            }

            const res = await fetch(`/checkout/${cartId}?method=CARD`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payload)
            });

            if (res.ok) return showModal('Success', 'Order placed successfully', () =>
              location.href = `/orders/customer/${customerId}`);
            return showModal('Payment Failed', await res.text());
          });

          function showModal(title, message, onClose) {
            const modal = document.getElementById('modal-tpl').content.cloneNode(true);
            modal.querySelector('#m-title').textContent = title;
            modal.querySelector('#m-body').textContent = message;
            const overlay = modal.querySelector('.modal-overlay');
            overlay.classList.remove('hidden');
            modal.querySelector('#m-ok').addEventListener('click', () => {
              overlay.remove();
              if (onClose) onClose();
            });
            document.body.appendChild(modal);
          }
        });
        /*]]>*/
    </script>

    <style>
        body {
          font-family: Arial, sans-serif;
          background: #f8f9fa;
          color: #212529;
          padding: 2rem;
        }
        .section {
          background: white;
          border-radius: 12px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.05);
          padding: 2rem;
          margin-bottom: 1rem;
        }
        .hidden { display: none; }
        label { display: block; margin: 0.5rem 0 0.2rem; }
        input, select {
          width: 100%; padding: 0.5rem;
          border: 1px solid #ced4da;
          border-radius: 6px;
        }
        input:invalid { border-color: #dc3545; }
        .btn {
          background-color: #0d6efd;
          color: white;
          padding: 0.75rem 1.5rem;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
        }
        .modal-overlay {
          position: fixed; top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0,0,0,0.5); display: flex;
          justify-content: center; align-items: center;
          z-index: 1000;
        }
        .modal {
          background: white;
          border-radius: 12px;
          padding: 2rem;
          max-width: 400px;
          width: 100%;
          text-align: center;
        }
        .modal h2 { margin-top: 0; }
        .modal button {
          margin-top: 1rem;
          padding: 0.5rem 1.25rem;
          border: none;
          border-radius: 6px;
          background: #0d6efd;
          color: white;
        }
    </style>
</head>
<body>

<div class="section">
    <h2>Payment Method</h2>
    <label><input type="radio" name="payMethod" value="CARD"> Card</label>
    <label><input type="radio" name="payMethod" value="CASH"> Cash</label>
</div>

<div class="section hidden" id="card-area">
    <h3>Select Card</h3>
    <div th:each="card : ${cards  }">
        <label>
            <input type="radio" name="cardOption" th:value="${card.id}"/>
            <span th:text="${card.brand + ' **** **** **** ' + card.last4}"></span>
            (<span th:text="${card.expiration}"></span>)
        </label>
    </div>
    <label>
        <input type="radio" name="cardOption" value="new"/>
        Use new card
    </label>

    <div class="hidden" id="new-fields">
        <label>Cardholder</label>
        <input id="holder" required>

        <label>Number</label>
        <input id="pan" inputmode="numeric" required>

        <label>Expiry (MM/YY)</label>
        <div style="display: flex; gap: 0.5rem;">
            <input id="mm" placeholder="MM" maxlength="2" inputmode="numeric" required>
            <input id="yy" placeholder="YY" maxlength="2" inputmode="numeric" required>
        </div>

        <label>CVV</label>
        <input id="cvv" maxlength="3" inputmode="numeric" required>
    </div>
</div>

<div class="section hidden" id="decline-box">
    <label><input type="checkbox" id="decline"/> Simulate decline</label>
</div>

<div style="text-align: center; margin-top: 2rem;">
    <button class="btn" id="pay-btn">Pay now</button>
</div>

<template id="modal-tpl">
    <div class="modal-overlay hidden">
        <div class="modal">
            <h2 id="m-title"></h2>
            <p id="m-body"></p>
            <button id="m-ok">OK</button>
        </div>
    </div>
</template>
</body>
</html>
